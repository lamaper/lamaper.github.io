<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="一、配置环境\r1、IDE安装\r我采用JetBrian开发的Clion进行开发，该软件对非商业用途免费，进入官网CLion Free for non-commercial use即可直接下载安装。\n2、CubeMX与CubeCLT\r我采用keysking开发的FubeMX协助进行环境安装。首先安装FubeMX，目录随意。安装完成后打开：\n从此处先安装STM32CubeMX，也可以在官网进行下载。下载好安装包后按默认路径安装，一路确定即可。\n之后继续从此处安装STM32CubeCLT，与上述操作一样地，下载好安装包后按默认路径安装，一路确定即可。\n此处安装可以参考爽！手把手教你用CLion开发STM32【大人，时代变啦！！！】，只需参考CubeMX与CubeCLT安装部分即可。\n3、OpenOCD安装\rOpenOCD则在官网Download OpenOCD for Windows下载并安装，同样下载好安装包后按默认路径安装，一路确定即可。\n4、Clion配置\r打开Clion： 点击设置（Settings）： 之后按照安装路径参考图片进行配置： 注意选择编译器时，使用arm-none-eabi-gcc.exe和，arm-none-eabi-g++.exe。\n之后修改CMake配置： 然后记住安装上述三个工具的路径，配置嵌入式开发环境： 最后在高级设置中启用调试器： 此处参考文献：\n爽！手把手教你用CLion开发STM32【大人，时代变啦！！！】 - bilibili\n【教程】配置 CLion 优雅开发 STM32 - 略无慕艳意 - 博客园\n但要注意，上述配置过程中会遇到一些问题，需要参考本文后续叠加起来综合使用。\n二、新建项目：\r首先在Clion中点击新建嵌入式的项目： 注意不要直接新建，先点击启动STM32CubeMX，然后点击Start My project from MCU： 由于学校下发的材料为基于STM32F103VET6的野火指南者开发板，输入芯片规格，选中芯片后点击Start Project： 按照如图方式选择调试模式，注意一定要选择Serial Wire： 选中后可以发现左侧GPIO标识变绿。最后设置项目名和工具链，注意工具链一定选择CMake： 最后点击右上角GENERATE CORE即可：\n记住路径后关闭窗口，回到Clion，将路径输入，可以发现此时可以创建项目了： 配置好Debug和Release两个CMake工具： 在此处点编辑配置： 进行OpenOCD配置： 注意此处要自己在任意位置新建一个.cfg文件，里面输入：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 # 野火FireDAP仿真器配置（基于CMSIS-DAP） source [find interface/cmsis-dap.cfg] # 选择SWD接口 transport select swd # 通信速率（1000kHz，兼容大多数情况） adapter speed 1000 # 目标芯片配置 source [find target/stm32f1x.cfg] # STM32F103VET6 Flash配置（512KB） set FLASH_SIZE 0x80000 # 复位配置（关键：启用系统复位） reset_config srst_only srst_nogate # 核心逻辑：利用before_init回调，在init执行前强制配置端口 # 解决CLion命令顺序导致的&#34;tcl port must be before init&#34;错误 proc before_init {} { # 禁用tcl和gdb端口（使用正确的语法：tcl port 而非 tcl_port） tcl port disabled gdb port disabled } 最后点击确定即可。\n">
<title>BIT ECE实习之STM32开发</title>

<link rel='canonical' href='https://lamaper.github.io/p/bit-ece%E5%AE%9E%E4%B9%A0%E4%B9%8Bstm32%E5%BC%80%E5%8F%91/'>

<link rel="stylesheet" href="/scss/style.min.64bf2e87443aa336f3a74572bf9f691351951bd9b72457795c5ab65e9b853c27.css"><meta property='og:title' content="BIT ECE实习之STM32开发">
<meta property='og:description' content="一、配置环境\r1、IDE安装\r我采用JetBrian开发的Clion进行开发，该软件对非商业用途免费，进入官网CLion Free for non-commercial use即可直接下载安装。\n2、CubeMX与CubeCLT\r我采用keysking开发的FubeMX协助进行环境安装。首先安装FubeMX，目录随意。安装完成后打开：\n从此处先安装STM32CubeMX，也可以在官网进行下载。下载好安装包后按默认路径安装，一路确定即可。\n之后继续从此处安装STM32CubeCLT，与上述操作一样地，下载好安装包后按默认路径安装，一路确定即可。\n此处安装可以参考爽！手把手教你用CLion开发STM32【大人，时代变啦！！！】，只需参考CubeMX与CubeCLT安装部分即可。\n3、OpenOCD安装\rOpenOCD则在官网Download OpenOCD for Windows下载并安装，同样下载好安装包后按默认路径安装，一路确定即可。\n4、Clion配置\r打开Clion： 点击设置（Settings）： 之后按照安装路径参考图片进行配置： 注意选择编译器时，使用arm-none-eabi-gcc.exe和，arm-none-eabi-g++.exe。\n之后修改CMake配置： 然后记住安装上述三个工具的路径，配置嵌入式开发环境： 最后在高级设置中启用调试器： 此处参考文献：\n爽！手把手教你用CLion开发STM32【大人，时代变啦！！！】 - bilibili\n【教程】配置 CLion 优雅开发 STM32 - 略无慕艳意 - 博客园\n但要注意，上述配置过程中会遇到一些问题，需要参考本文后续叠加起来综合使用。\n二、新建项目：\r首先在Clion中点击新建嵌入式的项目： 注意不要直接新建，先点击启动STM32CubeMX，然后点击Start My project from MCU： 由于学校下发的材料为基于STM32F103VET6的野火指南者开发板，输入芯片规格，选中芯片后点击Start Project： 按照如图方式选择调试模式，注意一定要选择Serial Wire： 选中后可以发现左侧GPIO标识变绿。最后设置项目名和工具链，注意工具链一定选择CMake： 最后点击右上角GENERATE CORE即可：\n记住路径后关闭窗口，回到Clion，将路径输入，可以发现此时可以创建项目了： 配置好Debug和Release两个CMake工具： 在此处点编辑配置： 进行OpenOCD配置： 注意此处要自己在任意位置新建一个.cfg文件，里面输入：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 # 野火FireDAP仿真器配置（基于CMSIS-DAP） source [find interface/cmsis-dap.cfg] # 选择SWD接口 transport select swd # 通信速率（1000kHz，兼容大多数情况） adapter speed 1000 # 目标芯片配置 source [find target/stm32f1x.cfg] # STM32F103VET6 Flash配置（512KB） set FLASH_SIZE 0x80000 # 复位配置（关键：启用系统复位） reset_config srst_only srst_nogate # 核心逻辑：利用before_init回调，在init执行前强制配置端口 # 解决CLion命令顺序导致的&#34;tcl port must be before init&#34;错误 proc before_init {} { # 禁用tcl和gdb端口（使用正确的语法：tcl port 而非 tcl_port） tcl port disabled gdb port disabled } 最后点击确定即可。\n">
<meta property='og:url' content='https://lamaper.github.io/p/bit-ece%E5%AE%9E%E4%B9%A0%E4%B9%8Bstm32%E5%BC%80%E5%8F%91/'>
<meta property='og:site_name' content='lamaper的博客'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='coding' /><meta property='article:tag' content='C/C&#43;&#43;' /><meta property='article:tag' content='STM32' /><meta property='article:tag' content='Clion' /><meta property='article:published_time' content='2025-09-08T16:11:23&#43;08:00'/><meta property='article:modified_time' content='2025-09-08T16:11:23&#43;08:00'/>
<meta name="twitter:title" content="BIT ECE实习之STM32开发">
<meta name="twitter:description" content="一、配置环境\r1、IDE安装\r我采用JetBrian开发的Clion进行开发，该软件对非商业用途免费，进入官网CLion Free for non-commercial use即可直接下载安装。\n2、CubeMX与CubeCLT\r我采用keysking开发的FubeMX协助进行环境安装。首先安装FubeMX，目录随意。安装完成后打开：\n从此处先安装STM32CubeMX，也可以在官网进行下载。下载好安装包后按默认路径安装，一路确定即可。\n之后继续从此处安装STM32CubeCLT，与上述操作一样地，下载好安装包后按默认路径安装，一路确定即可。\n此处安装可以参考爽！手把手教你用CLion开发STM32【大人，时代变啦！！！】，只需参考CubeMX与CubeCLT安装部分即可。\n3、OpenOCD安装\rOpenOCD则在官网Download OpenOCD for Windows下载并安装，同样下载好安装包后按默认路径安装，一路确定即可。\n4、Clion配置\r打开Clion： 点击设置（Settings）： 之后按照安装路径参考图片进行配置： 注意选择编译器时，使用arm-none-eabi-gcc.exe和，arm-none-eabi-g++.exe。\n之后修改CMake配置： 然后记住安装上述三个工具的路径，配置嵌入式开发环境： 最后在高级设置中启用调试器： 此处参考文献：\n爽！手把手教你用CLion开发STM32【大人，时代变啦！！！】 - bilibili\n【教程】配置 CLion 优雅开发 STM32 - 略无慕艳意 - 博客园\n但要注意，上述配置过程中会遇到一些问题，需要参考本文后续叠加起来综合使用。\n二、新建项目：\r首先在Clion中点击新建嵌入式的项目： 注意不要直接新建，先点击启动STM32CubeMX，然后点击Start My project from MCU： 由于学校下发的材料为基于STM32F103VET6的野火指南者开发板，输入芯片规格，选中芯片后点击Start Project： 按照如图方式选择调试模式，注意一定要选择Serial Wire： 选中后可以发现左侧GPIO标识变绿。最后设置项目名和工具链，注意工具链一定选择CMake： 最后点击右上角GENERATE CORE即可：\n记住路径后关闭窗口，回到Clion，将路径输入，可以发现此时可以创建项目了： 配置好Debug和Release两个CMake工具： 在此处点编辑配置： 进行OpenOCD配置： 注意此处要自己在任意位置新建一个.cfg文件，里面输入：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 # 野火FireDAP仿真器配置（基于CMSIS-DAP） source [find interface/cmsis-dap.cfg] # 选择SWD接口 transport select swd # 通信速率（1000kHz，兼容大多数情况） adapter speed 1000 # 目标芯片配置 source [find target/stm32f1x.cfg] # STM32F103VET6 Flash配置（512KB） set FLASH_SIZE 0x80000 # 复位配置（关键：启用系统复位） reset_config srst_only srst_nogate # 核心逻辑：利用before_init回调，在init执行前强制配置端口 # 解决CLion命令顺序导致的&#34;tcl port must be before init&#34;错误 proc before_init {} { # 禁用tcl和gdb端口（使用正确的语法：tcl port 而非 tcl_port） tcl port disabled gdb port disabled } 最后点击确定即可。\n">
    <link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/108182318?v=4" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    <img src="https://avatars.githubusercontent.com/u/108182318?v=4" width="300" height="300" class="site-logo" loading="lazy" alt="Avatar">
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">lamaper的博客</a></h1>
            <h2 class="site-description">你好，我是lamaper，BIT学生，喜欢与计算机相关的所有东西！</h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>首页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='https://github.com/lamaper' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                
                <span>Github</span>
            </a>
        </li>
        
        
        <li >
            <a href='https://www.cnblogs.com/lamaper' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>博客园</span>
            </a>
        </li>
        
        
        <li >
            <a href='https://space.bilibili.com/450695599' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Bilibili</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://lamaper.github.io/" selected>简体中文</option>
                                
                                    <option value="https://lamaper.github.io/en/" >English</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#一配置环境">一、配置环境</a>
      <ol>
        <li><a href="#1ide安装">1、IDE安装</a></li>
        <li><a href="#2cubemx与cubeclt">2、CubeMX与CubeCLT</a></li>
        <li><a href="#3openocd安装">3、OpenOCD安装</a></li>
        <li><a href="#4clion配置">4、Clion配置</a></li>
      </ol>
    </li>
    <li><a href="#二新建项目">二、新建项目：</a></li>
    <li><a href="#三开发">三、开发</a>
      <ol>
        <li><a href="#作业-寄存器亮灯">作业-寄存器亮灯</a></li>
        <li><a href="#作业-按键与亮灯">作业-按键与亮灯</a></li>
        <li><a href="#作业-蜂鸣器">作业-蜂鸣器</a></li>
        <li><a href="#作业-串口通信">作业-串口通信</a></li>
        <li><a href="#作业-七彩灯">作业-七彩灯</a></li>
        <li><a href="#作业-呼吸灯">作业-呼吸灯</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
            
                <form action="/search/" class="search-form widget" >
        <p>
            <label>搜索</label>
            <input name="keyword" required placeholder="输入关键词..." />
        
            <button title="搜索">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



            </button>
        </p>
    </form>
            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/coding/" >
                Coding
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/bit-ece%E5%AE%9E%E4%B9%A0%E4%B9%8Bstm32%E5%BC%80%E5%8F%91/">BIT ECE实习之STM32开发</a>
        </h2>
        
        
        <p class="article-preview">
            摘要：
            一、配置环境1、IDE安装我采用JetBrian开发的Clion进行开发，该软件对非商业用途免费，进入官网CLion Free for non-commercial use即可直接下载安装。
2、CubeMX与CubeCLT我采用keysking开发的FubeMX协助进行环境安装。首先安装FubeMX，目录随意。安装完成后打开：
从此处先安装STM32CubeMX，也可以在官网进行下载。下载 …
        </p>

    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Sep 08, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 14 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="一配置环境">一、配置环境
</h2><h3 id="1ide安装">1、IDE安装
</h3><p>我采用JetBrian开发的Clion进行开发，该软件对非商业用途免费，进入官网<a class="link" href="https://www.jetbrains.com/clion/"  target="_blank" rel="noopener"
    >CLion
Free for non-commercial use</a>即可直接下载安装。</p>
<h3 id="2cubemx与cubeclt">2、CubeMX与CubeCLT
</h3><p>我采用<a class="link" href="keysking.com" >keysking</a>开发的<a class="link" href="https://fubemx.keysking.com/"  target="_blank" rel="noopener"
    >FubeMX</a>协助进行环境安装。首先安装FubeMX，目录随意。安装完成后打开：</p>
<p><img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908145158804-268540574.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>从此处先安装STM32CubeMX，也可以在<a class="link" href="https://www.st.com/en/development-tools/stm32cubemx.html"  target="_blank" rel="noopener"
    >官网</a>进行下载。下载好安装包后按默认路径安装，一路确定即可。</p>
<p>之后继续从此处安装STM32CubeCLT，与上述操作一样地，下载好安装包后按默认路径安装，一路确定即可。</p>
<p>此处安装可以参考<a class="link" href="https://www.bilibili.com/video/BV1pnjizYEAk"  target="_blank" rel="noopener"
    >爽！手把手教你用CLion开发STM32【大人，时代变啦！！！】</a>，只需参考CubeMX与CubeCLT安装部分即可。</p>
<h3 id="3openocd安装">3、OpenOCD安装
</h3><p>OpenOCD则在官网<a class="link" href="https://gnutoolchains.com/arm-eabi/openocd/"  target="_blank" rel="noopener"
    >Download OpenOCD for Windows</a>下载并安装，同样下载好安装包后按默认路径安装，一路确定即可。</p>
<h3 id="4clion配置">4、Clion配置
</h3><p>打开Clion：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908145736866-965549483.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>点击设置（Settings）：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908145754297-1204800734.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>之后按照安装路径参考图片进行配置：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908145949129-126559454.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>注意选择编译器时，使用<code>arm-none-eabi-gcc.exe</code>和，<code>arm-none-eabi-g++.exe</code>。</p>
<p>之后修改CMake配置：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908150114272-1089790573.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>然后记住安装上述三个工具的路径，配置嵌入式开发环境：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908150209013-1789263183.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>最后在高级设置中启用调试器：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908150303882-1370651789.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>此处参考文献：</p>
<p><a class="link" href="https://www.bilibili.com/video/BV1pnjizYEAk/"  target="_blank" rel="noopener"
    >爽！手把手教你用CLion开发STM32【大人，时代变啦！！！】 - bilibili</a></p>
<p><a class="link" href="https://www.cnblogs.com/bfmhno3/articles/18857357"  target="_blank" rel="noopener"
    >【教程】配置 CLion 优雅开发 STM32 - 略无慕艳意 - 博客园</a></p>
<p>但要注意，上述配置过程中会遇到一些问题，需要参考本文后续叠加起来综合使用。</p>
<h2 id="二新建项目">二、新建项目：
</h2><p>首先在Clion中点击新建嵌入式的项目：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908150505549-190964277.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>注意不要直接新建，先点击<code>启动STM32CubeMX</code>，然后点击Start My project from MCU：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908150656217-1854978930.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>由于学校下发的材料为基于STM32F103VET6的<a class="link" href="https://doc.embedfire.com/products/link/zh/latest/mcu/stm32/stm32f103_zhinanzhe.html"  target="_blank" rel="noopener"
    >野火指南者开发板</a>，输入芯片规格，选中芯片后点击Start Project：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908150847943-82305246.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>按照如图方式选择调试模式，注意一定要选择Serial Wire：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908151008163-1576741069.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>选中后可以发现左侧GPIO标识变绿。最后设置项目名和工具链，注意工具链一定选择CMake：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908151203904-1496530551.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>最后点击右上角<code>GENERATE CORE</code>即可：<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908151303040-655512809.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>记住路径后关闭窗口，回到Clion，将路径输入，可以发现此时可以创建项目了：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908151358179-1569177076.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>配置好Debug和Release两个CMake工具：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908151425043-1593323770.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>在此处点编辑配置：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908151546087-1152064907.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>进行OpenOCD配置：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908151732896-2032115607.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>注意此处要自己在任意位置新建一个<code>.cfg</code>文件，里面输入：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 野火FireDAP仿真器配置（基于CMSIS-DAP）
</span></span><span class="line"><span class="cl">source [find interface/cmsis-dap.cfg]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 选择SWD接口
</span></span><span class="line"><span class="cl">transport select swd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 通信速率（1000kHz，兼容大多数情况）
</span></span><span class="line"><span class="cl">adapter speed 1000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 目标芯片配置
</span></span><span class="line"><span class="cl">source [find target/stm32f1x.cfg]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># STM32F103VET6 Flash配置（512KB）
</span></span><span class="line"><span class="cl">set FLASH_SIZE 0x80000
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 复位配置（关键：启用系统复位）
</span></span><span class="line"><span class="cl">reset_config srst_only srst_nogate
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 核心逻辑：利用before_init回调，在init执行前强制配置端口
</span></span><span class="line"><span class="cl"># 解决CLion命令顺序导致的&#34;tcl port must be before init&#34;错误
</span></span><span class="line"><span class="cl">proc before_init {} {
</span></span><span class="line"><span class="cl">    # 禁用tcl和gdb端口（使用正确的语法：tcl port 而非 tcl_port）
</span></span><span class="line"><span class="cl">    tcl port disabled
</span></span><span class="line"><span class="cl">    gdb port disabled
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后点击确定即可。</p>
<p>代码在Core目录下，其中Src存放.c或.cpp文件，Inc存放.h文件：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908151924160-99783125.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>此时如果连接开发板，点击绿色三角进行运行，若控制台显示如下良好，则表示配置完成。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[0mOpen On-Chip Debugger 0.12.0 (2024-09-16)
</span></span><span class="line"><span class="cl">. [https://github.com/sysprogs/openocd]
</span></span><span class="line"><span class="cl">Licensed under GNU GPL v2
</span></span><span class="line"><span class="cl">libusb1 d52e355daa09f17ce64819122cb067b8a2ee0d4b
</span></span><span class="line"><span class="cl">For bug reports, read
</span></span><span class="line"><span class="cl">        http://openocd.org/doc/doxygen/bugs.html
</span></span><span class="line"><span class="cl">before_init
</span></span><span class="line"><span class="cl">DEPRECATED! use &#39;tcl port&#39; not &#39;tcl_port&#39;
</span></span><span class="line"><span class="cl">DEPRECATED! use &#39;gdb port&#39;, not &#39;gdb_port&#39;
</span></span><span class="line"><span class="cl">DEPRECATED! use &#39;tcl port&#39; not &#39;tcl_port&#39;
</span></span><span class="line"><span class="cl">[0mInfo : CMSIS-DAP: SWD supported
</span></span><span class="line"><span class="cl">Info : CMSIS-DAP: Atomic commands supported
</span></span><span class="line"><span class="cl">Info : CMSIS-DAP: Test domain timer supported
</span></span><span class="line"><span class="cl">Info : CMSIS-DAP: FW Version = 2.0.0
</span></span><span class="line"><span class="cl">Info : CMSIS-DAP: Interface Initialised (SWD)
</span></span><span class="line"><span class="cl">Info : SWCLK/TCK = 1 SWDIO/TMS = 1 TDI = 0 TDO = 1 nTRST = 0 nRESET = 1
</span></span><span class="line"><span class="cl">Info : CMSIS-DAP: Interface ready
</span></span><span class="line"><span class="cl">Info : clock speed 1000 kHz
</span></span><span class="line"><span class="cl">Info : SWD DPIDR 0x1ba01477
</span></span><span class="line"><span class="cl">Info : [stm32f1x.cpu] Cortex-M3 r1p1 processor detected
</span></span><span class="line"><span class="cl">Info : [stm32f1x.cpu] target has 6 breakpoints, 4 watchpoints
</span></span><span class="line"><span class="cl">Info : [stm32f1x.cpu] Examination succeed
</span></span><span class="line"><span class="cl">Info : [stm32f1x.cpu] gdb port disabled
</span></span><span class="line"><span class="cl">[stm32f1x.cpu] halted due to breakpoint, current mode: Thread
</span></span><span class="line"><span class="cl">xPSR: 0x01000000 pc: 0x0800219c msp: 0x20010000
</span></span><span class="line"><span class="cl">** Programming Started **
</span></span><span class="line"><span class="cl">Info : device id = 0x10036414
</span></span><span class="line"><span class="cl">Info : flash size = 512 KiB
</span></span><span class="line"><span class="cl">Warn : Adding extra erase range, 0x080031ac .. 0x080037ff
</span></span><span class="line"><span class="cl">** Programming Finished **
</span></span><span class="line"><span class="cl">shutdown command invoked
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="三开发">三、开发
</h2><p>本节中左右代码已上传至Github，仓库地址https://github.com/lamaper/BIT_ECE_STM32。</p>
<p>本节中所有作业来自上课课件，课件已经上传至<a class="link" href="https://onedrive.bit101.cn/zh-CN/course/ECE%E5%AE%9E%E4%B9%A0I-100120050/"  target="_blank" rel="noopener"
    >BIT101仓库</a>，本课程编号：100120050。</p>
<p>本节中采用的硬件是学校派发的野火指南者开发板，本文采用<strong>HAL库</strong>开发而不是标准库。硬件官方参考文档：<a class="link" href="https://doc.embedfire.com/mcu/stm32/f103/hal_general/zh/latest/index.html"  target="_blank" rel="noopener"
    >\[野火\]STM32 HAL库开发实战指南-基于F103系列开发板—文档</a>，其中给出了开发板外设地址：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"> <span class="cm">/*片上外设基地址  */</span>
</span></span><span class="line"><span class="cl"> <span class="cp">#define PERIPH_BASE         ((unsigned int)0x40000000)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"> <span class="cm">/*总线基地址，GPIO都挂载到APB2上 */</span>
</span></span><span class="line"><span class="cl"> <span class="cp">#define APB2PERIPH_BASE     (PERIPH_BASE + 0x10000)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"> <span class="cm">/*GPIOB外设基地址*/</span>
</span></span><span class="line"><span class="cl"> <span class="cp">#define GPIOA_BASE          (APB2PERIPH_BASE + 0x0800)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"> <span class="cm">/* GPIOB寄存器地址,强制转换成指针 */</span>
</span></span><span class="line"><span class="cl"> <span class="cp">#define GPIOA_CRL           *(unsigned int*)(GPIOA_BASE+0x00)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> <span class="cp">#define GPIOA_CRH           *(unsigned int*)(GPIOA_BASE+0x04)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> <span class="cp">#define GPIOA_IDR           *(unsigned int*)(GPIOA_BASE+0x08)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> <span class="cp">#define GPIOA_ODR           *(unsigned int*)(GPIOA_BASE+0x0C)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> <span class="cp">#define GPIOA_BSRR          *(unsigned int*)(GPIOA_BASE+0x10)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> <span class="cp">#define GPIOA_BRR           *(unsigned int*)(GPIOA_BASE+0x14)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> <span class="cp">#define GPIOA_LCKR          *(unsigned int*)(GPIOA_BASE+0x18)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"> <span class="cm">/*RCC外设基地址*/</span>
</span></span><span class="line"><span class="cl"> <span class="cp">#define RCC_BASE           (AHBPERIPH_BASE + 0x1000)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> <span class="cm">/*RCC的AHB1时钟使能寄存器地址,强制转换成指针*/</span>
</span></span><span class="line"><span class="cl"> <span class="cp">#define RCC_APB2ENR        *(unsigned int*)(RCC_BASE+0x18)
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="作业-寄存器亮灯">作业-寄存器亮灯
</h3><p>作业内容：使用相应软件操作STM32开发板，用GPIO控制LED发光，用寄存器方式，分别地发射绿光、蓝光，用寄存器方式，控制LED发射黄光、紫光、白光，在黄、紫、白光中任选一种，提交工程压缩包。</p>
<p>首先查询官方操作手册，获取不同颜色LED灯的针脚信息以操作其发出不同颜色的光，创建文件<code>led.h</code>用于记录宏，之后创建LED控制宏以确保LED正常亮灭、定义一些快速操作的宏，方便后面快速调用颜色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#ifndef __LED_H
</span></span></span><span class="line"><span class="cl"><span class="cp">#define __LED_H
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @author lamaper(Guo Jun Qi 1120241725)
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;main.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* ---------- LED引脚与时钟定义 ---------- */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 红色LED（LED1）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define LED1_GPIO_PORT    GPIOB
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED1_GPIO_PIN     GPIO_PIN_5
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED1_CLK_ENABLE() __HAL_RCC_GPIOB_CLK_ENABLE()
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 绿色LED（LED2）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define LED2_GPIO_PORT    GPIOB
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED2_GPIO_PIN     GPIO_PIN_0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED2_CLK_ENABLE() __HAL_RCC_GPIOB_CLK_ENABLE()
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 蓝色LED（LED3）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define LED3_GPIO_PORT    GPIOB
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED3_GPIO_PIN     GPIO_PIN_1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED3_CLK_ENABLE() __HAL_RCC_GPIOB_CLK_ENABLE()
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* ---------- LED控制宏（低电平点亮） ---------- */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define LED_ON  GPIO_PIN_RESET  </span><span class="c1">// 低电平点亮
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define LED_OFF GPIO_PIN_SET    </span><span class="c1">// 高电平熄灭
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 基础控制宏
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define LED1_SetState(state) HAL_GPIO_WritePin(LED1_GPIO_PORT, LED1_GPIO_PIN, (state))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED2_SetState(state) HAL_GPIO_WritePin(LED2_GPIO_PORT, LED2_GPIO_PIN, (state))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED3_SetState(state) HAL_GPIO_WritePin(LED3_GPIO_PORT, LED3_GPIO_PIN, (state))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 快捷操作宏
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define LED1_On()  LED1_SetState(LED_ON)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED1_Off() LED1_SetState(LED_OFF)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED1_Toggle() HAL_GPIO_TogglePin(LED1_GPIO_PORT, LED1_GPIO_PIN)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define LED2_On()  LED2_SetState(LED_ON)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED2_Off() LED2_SetState(LED_OFF)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED2_Toggle() HAL_GPIO_TogglePin(LED2_GPIO_PORT, LED2_GPIO_PIN)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define LED3_On()  LED3_SetState(LED_ON)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED3_Off() LED3_SetState(LED_OFF)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED3_Toggle() HAL_GPIO_TogglePin(LED3_GPIO_PORT, LED3_GPIO_PIN)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* ---------- 组合颜色宏 ---------- */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define LED_Red()    do { LED1_On();  LED2_Off(); LED3_Off(); } while(0)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED_Green()  do { LED1_Off(); LED2_On();  LED3_Off(); } while(0)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED_Blue()   do { LED1_Off(); LED2_Off(); LED3_On();  } while(0)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED_Yellow() do { LED1_On();  LED2_On();  LED3_Off(); } while(0)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED_Purple() do { LED1_On();  LED2_Off(); LED3_On();  } while(0)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED_Cyan()   do { LED1_Off(); LED2_On();  LED3_On();  } while(0)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED_White()  do { LED1_On();  LED2_On();  LED3_On();  } while(0)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LED_RGBOff() do { LED1_Off(); LED2_Off(); LED3_Off(); } while(0)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* ---------- 函数声明 ---------- */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">LED_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="cm">/* __LED_H */</span><span class="cp">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在led.c中编辑初始化LED的函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;led.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @author lamaper (Guo Jun Qi 1120241725)
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 初始化LED对应的GPIO
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @note 配置为推挽输出、无上下拉、低速
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">LED_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStruct</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 使能GPIOB时钟
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">LED1_CLK_ENABLE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">LED2_CLK_ENABLE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">LED3_CLK_ENABLE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 配置GPIO为推挽输出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">GPIO_MODE_OUTPUT_PP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pull</span> <span class="o">=</span> <span class="n">GPIO_NOPULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Speed</span> <span class="o">=</span> <span class="n">GPIO_SPEED_FREQ_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 配置LED1引脚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">LED1_GPIO_PIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_GPIO_Init</span><span class="p">(</span><span class="n">LED1_GPIO_PORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GPIO_InitStruct</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 配置LED2引脚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">LED2_GPIO_PIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_GPIO_Init</span><span class="p">(</span><span class="n">LED2_GPIO_PORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GPIO_InitStruct</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 配置LED3引脚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">LED3_GPIO_PIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_GPIO_Init</span><span class="p">(</span><span class="n">LED3_GPIO_PORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GPIO_InitStruct</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 初始状态：所有LED熄灭
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">LED_RGBOff</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>之后就可以在main函数中配置基础逻辑了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">HW1_SpmLight</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="c1">// 用寄存器的方式，分别地发射绿光、蓝光
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">LED_Green</span><span class="p">();</span>  <span class="nf">HAL_Delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>  <span class="c1">// 绿灯亮500ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">LED_Blue</span><span class="p">();</span>   <span class="nf">HAL_Delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>  <span class="c1">// 蓝灯亮500ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">HW1_MixLight</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="c1">// 用寄存器的方式，控制LED发射黄光、紫光、白光
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">LED_Yellow</span><span class="p">();</span> <span class="nf">HAL_Delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>  <span class="c1">// 黄灯亮500ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">LED_Purple</span><span class="p">();</span> <span class="nf">HAL_Delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>  <span class="c1">// 紫灯亮500ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">LED_White</span><span class="p">();</span>  <span class="nf">HAL_Delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>  <span class="c1">// 白灯亮500ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">HW1_Submit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="c1">// 选择黄光、紫光、白光的任意一种提交工程压缩包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">LED_Yellow</span><span class="p">();</span> <span class="c1">// 黄灯长亮
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>编译运行后可以看到结果：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908154033897-326732413.png"
	
	
	
	loading="lazy"
	
	
></p>
<h3 id="作业-按键与亮灯">作业-按键与亮灯
</h3><p>作业内容：使用相应软件操作STM32开发板，使得按KEY1，控制LED灯在“红光-绿光-蓝光-白光”四种方式之间切换按KEY2，控制LED灯熄灭。</p>
<p>首先查询官方操作手册，获取KEY1和KEY2的针脚信息以操作其发出不同颜色的光，创建文件<code>key.h</code>用于记录宏：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#ifndef __KEY_H
</span></span></span><span class="line"><span class="cl"><span class="cp">#define __KEY_H
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;main.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 按键引脚定义（野火指南者开发板） */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// KEY1 -&gt; PC13
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define KEY1_GPIO_PORT    GPIOC
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KEY1_GPIO_PIN     GPIO_PIN_13
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KEY1_CLK_ENABLE() __HAL_RCC_GPIOA_CLK_ENABLE()
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// KEY2 -&gt; PA0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define KEY2_GPIO_PORT    GPIOA
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KEY2_GPIO_PIN     GPIO_PIN_0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KEY2_CLK_ENABLE() __HAL_RCC_GPIOC_CLK_ENABLE()
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 函数声明 */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">KEY_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint8_t</span> <span class="nf">KEY_Scan</span><span class="p">(</span><span class="n">GPIO_TypeDef</span><span class="o">*</span> <span class="n">GPIOx</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">GPIO_Pin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="cm">/* __KEY_H */</span><span class="cp">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>单片机中按键检测并没有被封装，因而需要我们自行实现按下的逻辑检测。按键机械触点断开、闭合时，由于触点的弹性作用，按键开关不会马上稳定接通或一下子断开，使用按键时会产生带波纹信号，需要用软件消抖处理滤波，不方便输入检测。</p>
<p><img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908154240409-446821006.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>本此实验采用的野火STM32指南者开发板（STM32F103VET6）板所搭载的按键带硬件消抖功能，它利用电容充放电的延时，消除了波纹，从而简化软件的处理，软件只需要直接检测引脚的电平即可。</p>
<p><img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908154257541-2118682686.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>从按键的原理图可知，这些按键在没有被按下的时候，GPIO引脚的输入状态为低电平；当按键按下时，GPIO引脚的输入状态为高电平。只要我们检测引脚的输入电平，即可判断按键是否被按下。</p>
<p>基于此在后续创建<code>key.c</code>控制按键识别，其中KEY_Init函数用来初始化按键，用KEY_Scan函数检测按钮状态，虽然硬件自带抖动消除，但是这里为了练习，使用HAL库的延时函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;key.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 初始化按键GPIO
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">KEY_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStruct</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 使能按键对应GPIO时钟
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">KEY1_CLK_ENABLE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">KEY2_CLK_ENABLE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 配置KEY1（PA0，上拉输入）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">KEY1_GPIO_PIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">GPIO_MODE_INPUT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pull</span> <span class="o">=</span> <span class="n">GPIO_PULLUP</span><span class="p">;</span>  <span class="c1">// 上拉输入，按键按下为低电平
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">HAL_GPIO_Init</span><span class="p">(</span><span class="n">KEY1_GPIO_PORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GPIO_InitStruct</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 配置KEY2（PC13，上拉输入）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">KEY2_GPIO_PIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">GPIO_MODE_INPUT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pull</span> <span class="o">=</span> <span class="n">GPIO_PULLUP</span><span class="p">;</span>  <span class="c1">// 上拉输入，按键按下为低电平
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">HAL_GPIO_Init</span><span class="p">(</span><span class="n">KEY2_GPIO_PORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GPIO_InitStruct</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @brief 按键扫描（带消抖，使用HAL_Delay）
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param GPIOx: 按键GPIO端口
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param GPIO_Pin: 按键GPIO引脚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @retval 1: 按键按下（已消抖），0: 未按下
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint8_t</span> <span class="nf">KEY_Scan</span><span class="p">(</span><span class="n">GPIO_TypeDef</span><span class="o">*</span> <span class="n">GPIOx</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">GPIO_Pin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">key_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// 按键松开标志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">key_up</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nf">HAL_GPIO_ReadPin</span><span class="p">(</span><span class="n">GPIOx</span><span class="p">,</span> <span class="n">GPIO_Pin</span><span class="p">)</span> <span class="o">==</span> <span class="n">GPIO_PIN_RESET</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">HAL_Delay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>  <span class="c1">// 消抖延时（使用HAL库延迟）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nf">HAL_GPIO_ReadPin</span><span class="p">(</span><span class="n">GPIOx</span><span class="p">,</span> <span class="n">GPIO_Pin</span><span class="p">)</span> <span class="o">==</span> <span class="n">GPIO_PIN_RESET</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">key_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// 标记按键按下
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>    <span class="c1">// 返回按下状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">HAL_GPIO_ReadPin</span><span class="p">(</span><span class="n">GPIOx</span><span class="p">,</span> <span class="n">GPIO_Pin</span><span class="p">)</span> <span class="o">==</span> <span class="n">GPIO_PIN_SET</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">HAL_Delay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>  <span class="c1">// 消抖延时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nf">HAL_GPIO_ReadPin</span><span class="p">(</span><span class="n">GPIOx</span><span class="p">,</span> <span class="n">GPIO_Pin</span><span class="p">)</span> <span class="o">==</span> <span class="n">GPIO_PIN_SET</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">key_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// 标记按键松开
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// 未按下
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>之后就可以在main函数中配置基础逻辑了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">HW2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">LED_RGBOff</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">mode</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 作业2：KEY1切换模式（红光→绿光→蓝光→白光循环）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nf">KEY_Scan</span><span class="p">(</span><span class="n">KEY1_GPIO_PORT</span><span class="p">,</span> <span class="n">KEY1_GPIO_PIN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_mode</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">current_mode</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1">// 超过白光模式(3)则回到红光(0)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">current_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 根据当前模式切换LED（直接使用led.h中的宏）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">switch</span><span class="p">(</span><span class="n">current_mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="nf">LED_Red</span><span class="p">();</span><span class="nf">HAL_Delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="nf">LED_Green</span><span class="p">();</span><span class="nf">HAL_Delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="nf">LED_Blue</span><span class="p">();</span><span class="nf">HAL_Delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>   <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="nf">LED_White</span><span class="p">();</span><span class="nf">HAL_Delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">default</span><span class="o">:</span> <span class="nf">LED_RGBOff</span><span class="p">();</span><span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 作业2：KEY2熄灭LED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nf">KEY_Scan</span><span class="p">(</span><span class="n">KEY2_GPIO_PORT</span><span class="p">,</span> <span class="n">KEY2_GPIO_PIN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_mode</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>  <span class="c1">// 标记为熄灭模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">LED_RGBOff</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">HAL_Delay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>  <span class="c1">// 消抖延时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="作业-蜂鸣器">作业-蜂鸣器
</h3><p>作业内容：使用相应软件操作STM32开发板，写一个函数，使用SysTick方法，计时0.25s使蜂鸣器产生n次短鸣+1长鸣，n=mod(学号末位)+1短鸣的时间为0.25s，长鸣时间为1s，每次鸣响之间间隔1s蜂鸣响起的同时，红色LED灯同时亮起。</p>
<p>我的学号末尾是5，后面采用5。</p>
<p>首先查询官方操作手册，获取蜂鸣器的针脚信息，创建文件beep.h用于记录宏，通过查询该开发板的<a class="link" href="https://doc.embedfire.com/release/selection_guide/zh/latest/_downloads/cbb914a3fb08877b29d6977584f21866/selection_guide.pdf"  target="_blank" rel="noopener"
    >技术手册</a>可以得知，这块开发板采用有源蜂鸣器。STM32 驱动蜂鸣器的核心原理，是通过GPIO 引脚输出控制信号，配合蜂鸣器自身的发声结构，最终将电信号转化为声音信号。对于有源蜂鸣器，其内部自带振荡电路且包含芯片，只需GPIO输出高低电平——通电响、断电停——即可使其发声。基于此，定义如下宏以方便开发：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#ifndef __BEEP_H
</span></span></span><span class="line"><span class="cl"><span class="cp">#define __BEEP_H
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;main.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;led.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// 用于控制红色LED（LED1）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* ---------- 蜂鸣器硬件配置 ---------- */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BEEP_GPIO_PORT        GPIOA                   </span><span class="cm">/* 蜂鸣器GPIO端口 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BEEP_GPIO_PIN         GPIO_PIN_8              </span><span class="cm">/* 蜂鸣器GPIO引脚 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BEEP_GPIO_CLK_ENABLE() __HAL_RCC_GPIOA_CLK_ENABLE()  </span><span class="cm">/* 蜂鸣器时钟使能 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 蜂鸣器控制宏（高电平触发鸣响） */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BEEP_ON  GPIO_PIN_SET
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BEEP_OFF GPIO_PIN_RESET
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BEEP_SetState(state) HAL_GPIO_WritePin(BEEP_GPIO_PORT, BEEP_GPIO_PIN, (state))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BEEP_On()  BEEP_SetState(BEEP_ON)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BEEP_Off() BEEP_SetState(BEEP_OFF)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 函数声明 */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">BEEP_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>                    <span class="c1">// 蜂鸣器GPIO初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">BEEP_AlarmWithLED</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">n</span><span class="p">);</span>       <span class="c1">// 1次短鸣 + 1次长鸣（同步红色LED亮灭）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="cm">/* __BEEP_H */</span><span class="cp">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>beep.c</code>中实现头文件中定义的函数。首先是初始化蜂鸣器的GPIO，最后实现蜂鸣器鸣叫函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;beep.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 蜂鸣器GPIO初始化：配置为推挽输出 */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">BEEP_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStruct</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 使能蜂鸣器GPIO时钟 */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">BEEP_GPIO_CLK_ENABLE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 配置蜂鸣器引脚为推挽输出 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">BEEP_GPIO_PIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">GPIO_MODE_OUTPUT_PP</span><span class="p">;</span>   <span class="c1">// 推挽输出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pull</span> <span class="o">=</span> <span class="n">GPIO_NOPULL</span><span class="p">;</span>           <span class="c1">// 无上下拉
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Speed</span> <span class="o">=</span> <span class="n">GPIO_SPEED_FREQ_LOW</span><span class="p">;</span>  <span class="c1">// 低速
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">HAL_GPIO_Init</span><span class="p">(</span><span class="n">BEEP_GPIO_PORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GPIO_InitStruct</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 初始状态：蜂鸣器关闭 */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">BEEP_Off</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 蜂鸣器鸣响+LED同步逻辑：n次短鸣(0.25s) + 1次长鸣(1s) */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">BEEP_AlarmWithLED</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 计算n：n = mod(学号末位,5) + 1 →
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 我的学号末位为5，即n = 5%5 +1 = 1 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 执行n次“短鸣+间隔” */</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BEEP_On</span><span class="p">();</span>   <span class="c1">// 蜂鸣器响
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">LED1_On</span><span class="p">();</span>   <span class="c1">// 红色LED亮
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">HAL_Delay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>  <span class="c1">// 短鸣持续0.25s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="nf">BEEP_Off</span><span class="p">();</span>  <span class="c1">// 蜂鸣器关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">LED1_Off</span><span class="p">();</span>  <span class="c1">// 红色LED灭
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">HAL_Delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span> <span class="c1">// 短鸣间隔1s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 执行1次“长鸣” */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">BEEP_On</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">LED1_On</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_Delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span> <span class="c1">// 长鸣持续1s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* 结束后关闭蜂鸣器和LED */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">BEEP_Off</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">LED1_Off</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="作业-串口通信">作业-串口通信
</h3><p>作业内容：使用相应软件操作STM32开发板，用直接配置串口的方式，向PC传输一句话在FLASH中存储一句话，并用DMA配置串口向PC传输。</p>
<p>串口通讯是一种设备间非常常用的串行通讯方式，因为它简单便捷，因此大部分电子设备都支持该通讯方式，电子工程师在调试设备时也经常使用该通讯方式输出调试信息。</p>
<p>USART（Universal Synchronous/Asynchronous Receiver/Transmitter）是 STM32 芯片里的一种串行通信外设。它的主要功能就是把数据（字节）转换成一位一位的电平信号，通过TX引脚发出去，或者从RX引脚接收一位一位的电平信号，再拼成字节给CPU。在本实验中，只用到USART1的异步模式，即串口通信。</p>
<p>基于上述原理，创建文件usart.h用于记录宏：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Created by lamaper on 2025/9/2.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef __USART_H
</span></span></span><span class="line"><span class="cl"><span class="cp">#define __USART_H
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;stm32f1xx_hal.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;stm32f1xx_hal_uart.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 外部句柄 */</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">UART_HandleTypeDef</span> <span class="n">huart1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">DMA_HandleTypeDef</span> <span class="n">hdma_tx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 初始化 */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">USART1_UART_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 普通发送 */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">UART_SendString</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* DMA 发送 */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">UART_SendString_DMA</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="cm">/* __USART_H */</span><span class="cp">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>之后开始编写初始化usart函数，首先开启USART1、GPIOA、DMA1时钟,之后配置引脚，在STM32F103系列芯片中，统一规定了USART1的引脚是PA9（TX，发送）和PA10（RX，接收）。在此处设置TX为复用推挽，使其能输出波形；RX作为输入，设为上拉状态，记为空闲。然后配置通信格式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Created by lamaper on 2025/9/2.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;usart.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">UART_HandleTypeDef</span> <span class="n">huart1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">DMA_HandleTypeDef</span> <span class="n">hdma_tx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">USART1_UART_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__HAL_RCC_USART1_CLK_ENABLE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__HAL_RCC_DMA1_CLK_ENABLE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* PA9 = TX, PA10 = RX */</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStruct</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">GPIO_PIN_9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">GPIO_MODE_AF_PP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Speed</span> <span class="o">=</span> <span class="n">GPIO_SPEED_FREQ_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_GPIO_Init</span><span class="p">(</span><span class="n">GPIOA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GPIO_InitStruct</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">GPIO_PIN_10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">GPIO_MODE_INPUT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pull</span> <span class="o">=</span> <span class="n">GPIO_NOPULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_GPIO_Init</span><span class="p">(</span><span class="n">GPIOA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GPIO_InitStruct</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* USART1 配置: 115200 8N1 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">huart1</span><span class="p">.</span><span class="n">Instance</span> <span class="o">=</span> <span class="n">USART1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">huart1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">BaudRate</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">huart1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">WordLength</span> <span class="o">=</span> <span class="n">UART_WORDLENGTH_8B</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">huart1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">StopBits</span> <span class="o">=</span> <span class="n">UART_STOPBITS_1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">huart1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Parity</span> <span class="o">=</span> <span class="n">UART_PARITY_NONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">huart1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">UART_MODE_TX_RX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">huart1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">HwFlowCtl</span> <span class="o">=</span> <span class="n">UART_HWCONTROL_NONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">huart1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">OverSampling</span> <span class="o">=</span> <span class="n">UART_OVERSAMPLING_16</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_UART_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* DMA 配置: USART1_TX = DMA1_Channel4 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdma_tx</span><span class="p">.</span><span class="n">Instance</span> <span class="o">=</span> <span class="n">DMA1_Channel4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdma_tx</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Direction</span> <span class="o">=</span> <span class="n">DMA_MEMORY_TO_PERIPH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdma_tx</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">PeriphInc</span> <span class="o">=</span> <span class="n">DMA_PINC_DISABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdma_tx</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">MemInc</span> <span class="o">=</span> <span class="n">DMA_MINC_ENABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdma_tx</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">PeriphDataAlignment</span> <span class="o">=</span> <span class="n">DMA_PDATAALIGN_BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdma_tx</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">MemDataAlignment</span> <span class="o">=</span> <span class="n">DMA_MDATAALIGN_BYTE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdma_tx</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">DMA_NORMAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">hdma_tx</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Priority</span> <span class="o">=</span> <span class="n">DMA_PRIORITY_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_DMA_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdma_tx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">__HAL_LINKDMA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="n">hdmatx</span><span class="p">,</span> <span class="n">hdma_tx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* DMA NVIC */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_NVIC_SetPriority</span><span class="p">(</span><span class="n">DMA1_Channel4_IRQn</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_NVIC_EnableIRQ</span><span class="p">(</span><span class="n">DMA1_Channel4_IRQn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">UART_SendString</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_UART_Transmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">str</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">),</span> <span class="n">HAL_MAX_DELAY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">UART_SendString_DMA</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_UART_Transmit_DMA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">str</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>STM32F1 的主存储器是片上Flash，既用来存程序，也能存数据。其掉电不丢失，适合存储固定配置；Flash以页为单位擦除，不能只擦除一个字节；以半字，即16bit为最小写入单位，必须2字节对齐。如果要操作，首先要解锁Flash，然后擦除页使其恢复0xFF，之后逐字（半字）写入数据，最后锁上Flash。</p>
<p>在flash.h中声明两个函数负责读写，同时选一个安全带页地址，本文选择STM32F103VET6 最后2K的起始地址（0x0807F800U）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Created by lamaper on 2025/9/2.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef __FLASH_H
</span></span></span><span class="line"><span class="cl"><span class="cp">#define __FLASH_H
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;stm32f1xx_hal.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 选一个安全的页地址（比如最后一页） */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define FLASH_PAGE_ADDR 0x0807F800U  </span><span class="c1">// STM32F103VET6 最后 2K 的起始地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Flash_Write</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Flash_Read</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="cm">/* __FLASH_H */</span><span class="cp">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在flash.c中实现他们：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Created by lamaper on 2025/9/2.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;flash.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Flash_Write</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_FLASH_Unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 先擦除页（注意：Flash 必须先擦才能重新写） */</span>
</span></span><span class="line"><span class="cl">    <span class="n">FLASH_EraseInitTypeDef</span> <span class="n">erase</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">pageError</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">erase</span><span class="p">.</span><span class="n">TypeErase</span> <span class="o">=</span> <span class="n">FLASH_TYPEERASE_PAGES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">erase</span><span class="p">.</span><span class="n">PageAddress</span> <span class="o">=</span> <span class="n">FLASH_PAGE_ADDR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">erase</span><span class="p">.</span><span class="n">NbPages</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_FLASHEx_Erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">erase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pageError</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 半字写入 */</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint16_t</span> <span class="n">halfword</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="n">halfword</span> <span class="o">|=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">HAL_FLASH_Program</span><span class="p">(</span><span class="n">FLASH_TYPEPROGRAM_HALFWORD</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">halfword</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_FLASH_Lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Flash_Read</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">volatile</span> <span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>之后就可以在main函数中配置基础逻辑了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">HW4</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">USART1_UART_Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* 1. 普通发送 */</span>
</span></span><span class="line"><span class="cl">  <span class="nf">UART_SendString</span><span class="p">(</span><span class="s">&#34;Hello, I&#39;m lamaper! This is UART direct send!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* 2. Flash 存储一句话 */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;Hello from Flash + DMA!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Flash_Write</span><span class="p">(</span><span class="n">FLASH_PAGE_ADDR</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* 3. 读回并用 DMA 发送 */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Flash_Read</span><span class="p">(</span><span class="n">FLASH_PAGE_ADDR</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">UART_SendString_DMA</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>此外，注意到电脑本身并没有串口监控程序，需要单另下载，因而在Microsoft Store中下载相关工具，启动串口监听，有如下结果：
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908155822439-1732845926.png"
	
	
	
	loading="lazy"
	
		alt="46541a11663cc8b9da7217d985890d27"
	
	
>
<img src="https://img2024.cnblogs.com/blog/2914490/202509/2914490-20250908155900023-455134809.png"
	
	
	
	loading="lazy"
	
	
></p>
<h3 id="作业-七彩灯">作业-七彩灯
</h3><p>作业内容：使用相应软件操作STM32开发板，以TIM3输出PWM，控制全彩LED灯变换颜色以另一个TIM作为计数器，每1s产生1次中断以中断控制一个状态机，改变全彩灯的CCR达到效果：赤-橙-黄-绿-青-蓝-紫，七种颜色循环切换，每1s切换一个颜色。</p>
<p>PWM 是 Pulse Width Modulation（脉冲宽度调制）的缩写，是一种通过改变脉冲信号的高电平持续时间与周期的比例，来模拟信号效果的数字控制技术。STM32 的定时器，如TIM3，可硬件生成高精度 PWM 信号，无需 CPU 持续干预。对 LED 来说，在频率足够高的情况下，人眼会因为视觉暂留把高频闪烁看作持续的光。TIMx作为PWM的时基有频率公式：
</p>
$$
f_{PWM} = \frac{f_{TIMCLK}}{(PSC+1) \times (ARR+1)}
$$<p>其中ARR为自动重装载寄存器，决定周期长度，即计数上限；PSC为预分频器，决定计数节拍变慢多少；CRR是捕获/比较寄存器，对应占空比。在STM32F103系列芯片中，TIM3有多个通道能做PWM，通过重映射可以把它们映射到开发板的引脚上：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Created by lamaper on 2025/9/2.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef __TIM_H
</span></span></span><span class="line"><span class="cl"><span class="cp">#define __TIM_H
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;stm32f1xx_hal.h&#34;      // HAL 基础</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;stm32f1xx_hal_tim.h&#34;  // TIM HAL</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 全局句柄（只声明） */</span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="n">TIM_HandleTypeDef</span> <span class="n">htim3</span><span class="p">;</span> <span class="c1">// PWM (RGB)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="n">TIM_HandleTypeDef</span> <span class="n">htim4</span><span class="p">;</span> <span class="c1">// 1s 周期中断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 初始化 */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TIM3_PWM_Init</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">arr</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">psc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TIM4_1s_Init</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">arr</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">psc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 设置 RGB 占空比：0~arr（arr=自动重装值） */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">LED_SetRGB</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">r</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">g</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 作业5：七彩灯（1s 切换） */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Rainbow_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* 作业6：四彩呼吸灯（周期 1.5s） */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Breath_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">LED_ChannelTest</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>接下来实现切换颜色。这里应作业要求，使用另一个计时器，本文采用TIM4.切换颜色并不需要高频变换，最自然的办法是使用计时器做一个1Hz的软节拍，每1s产生一次更新中断。NVIC 开启 TIM4_IRQn，在TIM4_IRQHandler 里调用HAL_TIM_IRQHandler，最终会进入HAL_TIM_PeriodElapsedCallback。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">IM_HandleTypeDef</span> <span class="n">htim3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">TIM_HandleTypeDef</span> <span class="n">htim4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef M_PI
</span></span></span><span class="line"><span class="cl"><span class="cp">#define M_PI 3.14159265358979323846
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span> <span class="n">MODE_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MODE_RAINBOW</span><span class="p">,</span> <span class="n">MODE_BREATH</span> <span class="p">}</span> <span class="n">TimerMode_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">TimerMode_t</span> <span class="n">g_mode</span> <span class="o">=</span> <span class="n">MODE_NONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TIM3_PWM_Init</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">arr</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">psc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__HAL_RCC_TIM3_CLK_ENABLE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__HAL_RCC_GPIOB_CLK_ENABLE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__HAL_RCC_AFIO_CLK_ENABLE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* TIM3 部分重映射: CH2-&gt;PB5, CH3-&gt;PB0, CH4-&gt;PB1 */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__HAL_AFIO_REMAP_TIM3_PARTIAL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStruct</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Mode</span>  <span class="o">=</span> <span class="n">GPIO_MODE_AF_PP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pull</span>  <span class="o">=</span> <span class="n">GPIO_NOPULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Speed</span> <span class="o">=</span> <span class="n">GPIO_SPEED_FREQ_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* R/G/B 对应引脚 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">GPIO_PIN_5</span><span class="p">;</span> <span class="nf">HAL_GPIO_Init</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GPIO_InitStruct</span><span class="p">);</span> <span class="c1">// CH2 → PB5 → R
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">GPIO_PIN_0</span><span class="p">;</span> <span class="nf">HAL_GPIO_Init</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GPIO_InitStruct</span><span class="p">);</span> <span class="c1">// CH3 → PB0 → G
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">GPIO_PIN_1</span><span class="p">;</span> <span class="nf">HAL_GPIO_Init</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GPIO_InitStruct</span><span class="p">);</span> <span class="c1">// CH4 → PB1 → B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* TIM3 基本参数 */</span>
</span></span><span class="line"><span class="cl">    <span class="n">htim3</span><span class="p">.</span><span class="n">Instance</span> <span class="o">=</span> <span class="n">TIM3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">htim3</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Prescaler</span>         <span class="o">=</span> <span class="n">psc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">htim3</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">CounterMode</span>       <span class="o">=</span> <span class="n">TIM_COUNTERMODE_UP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">htim3</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Period</span>            <span class="o">=</span> <span class="n">arr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">htim3</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">ClockDivision</span>     <span class="o">=</span> <span class="n">TIM_CLOCKDIVISION_DIV1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">htim3</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">AutoReloadPreload</span> <span class="o">=</span> <span class="n">TIM_AUTORELOAD_PRELOAD_DISABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_TIM_PWM_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 三路 PWM 通道配置：有效低（低电平点亮，数值越大越亮） */</span>
</span></span><span class="line"><span class="cl">    <span class="n">TIM_OC_InitTypeDef</span> <span class="n">sOC</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">sOC</span><span class="p">.</span><span class="n">OCMode</span>     <span class="o">=</span> <span class="n">TIM_OCMODE_PWM1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sOC</span><span class="p">.</span><span class="n">Pulse</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sOC</span><span class="p">.</span><span class="n">OCPolarity</span> <span class="o">=</span> <span class="n">TIM_OCPOLARITY_LOW</span><span class="p">;</span>      <span class="c1">// ★ 有效低
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sOC</span><span class="p">.</span><span class="n">OCFastMode</span> <span class="o">=</span> <span class="n">TIM_OCFAST_DISABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_TIM_PWM_ConfigChannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sOC</span><span class="p">,</span> <span class="n">TIM_CHANNEL_2</span><span class="p">);</span> <span class="c1">// R
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">HAL_TIM_PWM_ConfigChannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sOC</span><span class="p">,</span> <span class="n">TIM_CHANNEL_3</span><span class="p">);</span> <span class="c1">// G
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">HAL_TIM_PWM_ConfigChannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sOC</span><span class="p">,</span> <span class="n">TIM_CHANNEL_4</span><span class="p">);</span> <span class="c1">// B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_TIM_PWM_Start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim3</span><span class="p">,</span> <span class="n">TIM_CHANNEL_2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_TIM_PWM_Start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim3</span><span class="p">,</span> <span class="n">TIM_CHANNEL_3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_TIM_PWM_Start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim3</span><span class="p">,</span> <span class="n">TIM_CHANNEL_4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">TIM4_Base_Init</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">arr</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">psc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__HAL_RCC_TIM4_CLK_ENABLE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">htim4</span><span class="p">.</span><span class="n">Instance</span> <span class="o">=</span> <span class="n">TIM4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">htim4</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Prescaler</span>         <span class="o">=</span> <span class="n">psc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">htim4</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">CounterMode</span>       <span class="o">=</span> <span class="n">TIM_COUNTERMODE_UP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">htim4</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Period</span>            <span class="o">=</span> <span class="n">arr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">htim4</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">ClockDivision</span>     <span class="o">=</span> <span class="n">TIM_CLOCKDIVISION_DIV1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">htim4</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">AutoReloadPreload</span> <span class="o">=</span> <span class="n">TIM_AUTORELOAD_PRELOAD_DISABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_TIM_Base_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_TIM_Base_Start_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_NVIC_SetPriority</span><span class="p">(</span><span class="n">TIM4_IRQn</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HAL_NVIC_EnableIRQ</span><span class="p">(</span><span class="n">TIM4_IRQn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">LED_SetRGB</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">r</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">g</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">uint16_t</span> <span class="n">ARR</span> <span class="o">=</span> <span class="nf">__HAL_TIM_GET_AUTORELOAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="n">ARR</span><span class="p">)</span> <span class="n">r</span> <span class="o">=</span> <span class="n">ARR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;</span> <span class="n">ARR</span><span class="p">)</span> <span class="n">g</span> <span class="o">=</span> <span class="n">ARR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="n">ARR</span><span class="p">)</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ARR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim3</span><span class="p">,</span> <span class="n">TIM_CHANNEL_2</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span> <span class="c1">// R -&gt; PB5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim3</span><span class="p">,</span> <span class="n">TIM_CHANNEL_3</span><span class="p">,</span> <span class="n">g</span><span class="p">);</span> <span class="c1">// G -&gt; PB0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">__HAL_TIM_SET_COMPARE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim3</span><span class="p">,</span> <span class="n">TIM_CHANNEL_4</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span> <span class="c1">// B -&gt; PB1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* ==========================================================================
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 作业5：七彩灯（1s 切换，红→橙→黄→绿→青→蓝→紫）
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ========================================================================== */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">rainbow_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Rainbow_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">TIM4_Base_Init</span><span class="p">(</span><span class="mi">999</span><span class="p">,</span> <span class="mi">7999</span><span class="p">);</span>  <span class="c1">// 1s 节拍
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rainbow_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">g_mode</span> <span class="o">=</span> <span class="n">MODE_RAINBOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">Rainbow_Update</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">uint16_t</span> <span class="n">ARR</span> <span class="o">=</span> <span class="nf">__HAL_TIM_GET_AUTORELOAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">rainbow_state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="nf">LED_SetRGB</span><span class="p">(</span><span class="n">ARR</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>        <span class="c1">// 红
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="nf">LED_SetRGB</span><span class="p">(</span><span class="n">ARR</span><span class="p">,</span> <span class="n">ARR</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>        <span class="c1">// 橙 = 红 + 半绿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="nf">LED_SetRGB</span><span class="p">(</span><span class="n">ARR</span><span class="p">,</span> <span class="n">ARR</span><span class="p">,</span>   <span class="mi">0</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>        <span class="c1">// 黄 = 红 + 绿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="nf">LED_SetRGB</span><span class="p">(</span>  <span class="mi">0</span><span class="p">,</span> <span class="n">ARR</span><span class="p">,</span>   <span class="mi">0</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>        <span class="c1">// 绿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="mi">4</span><span class="o">:</span> <span class="nf">LED_SetRGB</span><span class="p">(</span>  <span class="mi">0</span><span class="p">,</span> <span class="n">ARR</span><span class="p">,</span> <span class="n">ARR</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>        <span class="c1">// 青 = 绿 + 蓝
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="mi">5</span><span class="o">:</span> <span class="nf">LED_SetRGB</span><span class="p">(</span>  <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="n">ARR</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>        <span class="c1">// 蓝
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="mi">6</span><span class="o">:</span> <span class="nf">LED_SetRGB</span><span class="p">(</span><span class="n">ARR</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="n">ARR</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>        <span class="c1">// 紫 = 红 + 蓝
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">rainbow_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">rainbow_state</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>之后进行编译和烧录即可。</p>
<h3 id="作业-呼吸灯">作业-呼吸灯
</h3><p>作业内容：使用相应软件操作STM32开发板，产生4彩（红、绿、蓝、白）呼吸灯，呼吸周期为1.x秒（x为学号尾数），CCR更新周期不高于0.2s。</p>
<p>呼吸灯的核心是占空比的周期性变化。首先回顾PWM的内容。PWM 是 Pulse Width Modulation（脉冲宽度调制）的缩写，是一种通过改变脉冲信号的高电平持续时间与周期的比例，来模拟信号效果的数字控制技术。STM32 的定时器，如TIM3，可硬件生成高精度 PWM 信号，无需 CPU 持续干预。对 LED 来说，在频率足够高的情况下，人眼会因为视觉暂留把高频闪烁看作持续的光。TIMx作为PWM的时基有频率公式：
</p>
$$
f_{PWM} = \frac{f_{TIMCLK}}{(PSC+1) \times (ARR+1)}
$$<p>其中ARR为自动重装载寄存器，决定周期长度，即计数上限；PSC为预分频器，决定计数节拍变慢多少；CRR是捕获/比较寄存器，对应占空比。因而只需让CCR随着时间先增再减就能实现呼吸效果。本文采用余弦函数产生更平滑的呼吸效果：
</p>
$$
duty(t) = \frac{1-\cos{(\frac{2\pi t}{T}})}{2}
$$<p>其中duty∈[0,1]，T为呼吸周期。
之后设置两个计时器，按照作业5的形式定义TIM3和TIM4的行为，这里不再赘述。
最终在上一节代码之后追加：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define BREATH_PERIOD 1.5f
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BREATH_DT     0.1f
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">uint16_t</span> <span class="n">breath_step</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">uint8_t</span>  <span class="n">breath_color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Breath_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">TIM4_Base_Init</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="mi">7999</span><span class="p">);</span>  <span class="c1">// 0.1s 节拍
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">breath_step</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">breath_color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">g_mode</span> <span class="o">=</span> <span class="n">MODE_BREATH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">Breath_Update</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">uint16_t</span> <span class="n">ARR</span> <span class="o">=</span> <span class="nf">__HAL_TIM_GET_AUTORELOAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">uint16_t</span> <span class="n">steps_per_cycle</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)(</span><span class="n">BREATH_PERIOD</span> <span class="o">/</span> <span class="n">BREATH_DT</span><span class="p">);</span> <span class="c1">// 例如1.5/0.1=15
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">x</span>    <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">breath_step</span> <span class="o">/</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">steps_per_cycle</span><span class="p">;</span>       <span class="c1">// 0..1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">float</span> <span class="n">duty</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0f</span> <span class="o">-</span> <span class="nf">cosf</span><span class="p">(</span><span class="mf">2.0f</span> <span class="o">*</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">M_PI</span> <span class="o">*</span> <span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.5f</span><span class="p">;</span>      <span class="c1">// 余弦曲线 0..1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint16_t</span> <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)(</span><span class="n">duty</span> <span class="o">*</span> <span class="n">ARR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">breath_color</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="nf">LED_SetRGB</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>           <span class="k">break</span><span class="p">;</span>  <span class="c1">// 红
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="nf">LED_SetRGB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>           <span class="k">break</span><span class="p">;</span>  <span class="c1">// 绿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="nf">LED_SetRGB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>           <span class="k">break</span><span class="p">;</span>  <span class="c1">// 蓝
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="nf">LED_SetRGB</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>           <span class="k">break</span><span class="p">;</span>  <span class="c1">// 白
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">default</span><span class="o">:</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">breath_step</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">breath_step</span> <span class="o">&gt;=</span> <span class="n">steps_per_cycle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">breath_step</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">breath_color</span> <span class="o">=</span> <span class="p">(</span><span class="n">breath_color</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// 红→绿→蓝→白
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/coding/">Coding</a>
        
            <a href="/tags/c/c&#43;&#43;/">C/C&#43;&#43;</a>
        
            <a href="/tags/stm32/">STM32</a>
        
            <a href="/tags/clion/">Clion</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
	const mainArticleElement = document.querySelector(".main-article");
        renderMathInElement(mainArticleElement, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>

    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/%E4%B8%80%E4%BA%9B%E7%A5%9E%E5%A5%87%E7%9A%84c%E8%AF%AD%E8%A8%80%E9%A2%98%E7%9B%AE2/">
        
        

        <div class="article-details">
            <h2 class="article-title">一些神奇的C语言题目（2）</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/%E4%B8%80%E4%BA%9B%E7%A5%9E%E5%A5%87%E7%9A%84c%E8%AF%AD%E8%A8%80%E9%A2%98%E7%9B%AE1/">
        
        

        <div class="article-details">
            <h2 class="article-title">一些神奇的C语言题目（1）</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/qt6.7.3msvc2022%E5%AE%89%E8%A3%85%E5%A4%96%E9%83%A8%E5%BA%93qxlsx/">
        
        

        <div class="article-details">
            <h2 class="article-title">Qt6.7.3（MSVC2022）安装外部库QXlsx</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/qt6.7.3%E9%9D%99%E6%80%81%E7%BC%96%E8%AF%91%E5%85%A8%E8%BF%87%E7%A8%8B/">
        
        

        <div class="article-details">
            <h2 class="article-title">Qt6.7.3静态编译全过程</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/rust%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B01/">
        
        

        <div class="article-details">
            <h2 class="article-title">Rust学习笔记（1）</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2025 lamaper
    </section>
    
    <section class="powerby">
        

        <p>博客由 <b><a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a></b> 强力驱动，主题采用由 <b><a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a></b> 设计的 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="%s">Stack</a></b> ，并由 lamaper 个性化修改。</p>
        
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<style>
  body {
      background: url("https://img1.baidu.com/it/u=546422228,54853596&fm=253&fmt=auto&app=138&f=GIF?w=1164&h=500") no-repeat center top;
      background-size: cover;
      background-attachment: fixed;
  }

 
  :root[data-scheme="dark"] body {
  background-image: none;
   
  background-color: var(--body-background);
  }
</style>
    </body>
</html>
